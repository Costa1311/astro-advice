export const runtime = 'edge';
import { NextResponse } from "next/server";
import { getDestinyNumber } from "@/utils/getDestinyNumber";

const getZodiacSign = (deg: number) => {
  const signs = [
    "–û–≤–µ–Ω",
    "–¢–µ–ª–µ—Ü",
    "–ë–ª–∏–∑–Ω–µ—Ü—ã",
    "–†–∞–∫",
    "–õ–µ–≤",
    "–î–µ–≤–∞",
    "–í–µ—Å—ã",
    "–°–∫–æ—Ä–ø–∏–æ–Ω",
    "–°—Ç—Ä–µ–ª–µ—Ü",
    "–ö–æ–∑–µ—Ä–æ–≥",
    "–í–æ–¥–æ–ª–µ–π",
    "–†—ã–±—ã",
  ];
  const normalizedDeg = ((deg % 360) + 360) % 360;
  const index = Math.floor(normalizedDeg / 30);
  return signs[index];
};

export async function POST(request: Request) {
  try {
    const { name, planets, isPaid, date } = await request.json();
    const destinyNumber = getDestinyNumber(date);

    // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Å –≥—Ä–∞–¥—É—Å–∞–º–∏ –¥–ª—è –ò–ò
    const detailedPlanets = Object.entries(planets)
      .map(
        ([p, d]) =>
          `${p}: ${getZodiacSign(d as number)} (${Math.round((d as number) % 30)}¬∞)`,
      )
      .join(", ");

    const sunSign = getZodiacSign(planets.Sun);
    const moonSign = getZodiacSign(planets.Moon);

    let systemMessage = "";
    let userPrompt = "";

    if (isPaid) {
      systemMessage = `–¢—ã ‚Äî —ç–ª–∏—Ç–Ω—ã–π –ø—Ä–∞–∫—Ç–∏–∫—É—é—â–∏–π –∞—Å—Ç—Ä–æ–ø—Å–∏—Ö–æ–ª–æ–≥ –∏ –Ω—É–º–µ—Ä–æ–ª–æ–≥. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî —Å–æ—Å—Ç–∞–≤–∏—Ç—å VIP-—Ä–∞–∑–±–æ—Ä –Ω–∞—Ç–∞–ª—å–Ω–æ–π –∫–∞—Ä—Ç—ã –¥–ª—è ${name}. –û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –≥–ª—É–±–æ–∫–∏–º, —ç–∫—Å–ø–µ—Ä—Ç–Ω—ã–º –∏ –æ–±—ä–µ–º–Ω—ã–º.`;
      userPrompt = `
        –î–ê–ù–ù–´–ï –î–õ–Ø –ê–ù–ê–õ–ò–ó–ê:
        - –ò–º—è: ${name}
        - –î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è: ${date} 
        - –ü–æ–ª–æ–∂–µ–Ω–∏—è –ø–ª–∞–Ω–µ—Ç: ${detailedPlanets}
        - –ß–∏—Å–ª–æ –°—É–¥—å–±—ã: ${destinyNumber}

        –í–ê–ñ–ù–û–ï –ó–ê–î–ê–ù–ò–ï: 
        –í —Å–ø–∏—Å–∫–µ –ø–ª–∞–Ω–µ—Ç –º–æ–∂–µ—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞—Ç—å –õ–∏–ª–∏—Ç (–ß–µ—Ä–Ω–∞—è –õ—É–Ω–∞). 
        –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–∏ –ø–æ–ª–æ–∂–µ–Ω–∏–µ –õ–∏–ª–∏—Ç –Ω–∞ –¥–∞—Ç—É —Ä–æ–∂–¥–µ–Ω–∏—è ${date} –∏ –≤–∫–ª—é—á–∏ –µ—ë –ø–æ–¥—Ä–æ–±–Ω—ã–π —Ä–∞–∑–±–æ—Ä –≤ —Ä–∞–∑–¥–µ–ª ‚Ññ3 "–¢–µ–Ω–µ–≤–∞—è —Å—Ç–æ—Ä–æ–Ω–∞". 
        –ù–µ –ø–∏—à–∏ —Ñ—Ä–∞–∑—É "–õ–∏–ª–∏—Ç –Ω–µ —É–∫–∞–∑–∞–Ω–∞", –ø—Ä–æ—Å—Ç–æ —Å—Ä–∞–∑—É –¥–∞–≤–∞–π –µ—ë –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—é –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–≤–æ–∏—Ö –∑–Ω–∞–Ω–∏–π —ç—Ñ–µ–º–µ—Ä–∏–¥.

        –°–¢–†–£–ö–¢–£–†–ê –û–¢–í–ï–¢–ê (–ü–∏—à–∏ —Å—Ç—Ä–æ–≥–æ –±–µ–∑ —Å–∏–º–≤–æ–ª–æ–≤ **, –∏—Å–ø–æ–ª—å–∑—É–π –¥–≤–æ–µ—Ç–æ—á–∏—è –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤):
        
        üåü 1. –ê–†–•–ï–¢–ò–ü –ò –ü–†–ï–î–ù–ê–ó–ù–ê–ß–ï–ù–ò–ï:
        –°–∏–Ω—Ç–µ–∑–∏—Ä—É–π –≤–ª–∏—è–Ω–∏–µ –°–æ–ª–Ω—Ü–∞ –∏ –ß–∏—Å–ª–∞ –°—É–¥—å–±—ã (${destinyNumber}). –í —á–µ–º –∑–∞–∫–ª—é—á–∞–µ—Ç—Å—è –≤—ã—Å—à–∞—è –º–∏—Å—Å–∏—è —ç—Ç–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞? –ö–∞–∫—É—é –≥–ª–∞–≤–Ω—É—é –æ—à–∏–±–∫—É –ø—Ä–æ—à–ª–æ–≥–æ –≤–æ–ø–ª–æ—â–µ–Ω–∏—è –æ–Ω –¥–æ–ª–∂–µ–Ω –∏—Å–ø—Ä–∞–≤–∏—Ç—å?

        üí∞ 2. –§–ò–ù–ê–ù–°–û–í–ê–Ø –°–¢–†–ê–¢–ï–ì–ò–Ø:
        –ù–∞ –æ—Å–Ω–æ–≤–µ –ú–∞—Ä—Å–∞ –∏ –Æ–ø–∏—Ç–µ—Ä–∞ –æ–ø—Ä–µ–¥–µ–ª–∏ "–¥–µ–Ω–µ–∂–Ω—ã–π –∫–æ–¥": —á–µ—Ä–µ–∑ –∫–∞–∫–∏–µ –¥–µ–π—Å—Ç–≤–∏—è –ø—Ä–∏—Ö–æ–¥—è—Ç —Ä–µ—Å—É—Ä—Å—ã? –°—Ç–æ–∏—Ç –ª–∏ –∏–¥—Ç–∏ –≤ –±–∏–∑–Ω–µ—Å –∏–ª–∏ —Ä–∞–∑–≤–∏–≤–∞—Ç—å—Å—è –≤ –Ω–∞–π–º–µ? –ù–∞–∑–æ–≤–∏ 3 –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –Ω–∏—à–∏ –¥–ª—è —É—Å–ø–µ—Ö–∞.

        üåö 3. –¢–ï–ù–ï–í–ê–Ø –°–¢–û–†–û–ù–ê –ò –ü–°–ò–•–û–õ–û–ì–ò–Ø (–õ–ò–õ–ò–¢):
        –†–∞–∑–±–µ—Ä–∏ –í–µ–Ω–µ—Ä—É –∏ –õ–∏–ª–∏—Ç (–ß–µ—Ä–Ω—É—é –õ—É–Ω—É). –ö–∞–∫–æ–π —Ç–∏–ø –ø–∞—Ä—Ç–Ω–µ—Ä–∞ –ø—Ä–∏—Ç—è–Ω–µ—Ç —ç—Ç–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞, –∞ –∫–∞–∫–æ–π ‚Äî —Ä–∞–∑—Ä—É—à–∏—Ç? –û–ø–∏—à–∏ –µ–≥–æ "–¢–µ–Ω—å" ‚Äî —Å–∫—Ä—ã—Ç—ã–µ –∫–∞—á–µ—Å—Ç–≤–∞, —Å—Ç—Ä–∞—Ö–∏ –∏ –ø–æ–¥–∞–≤–ª–µ–Ω–Ω—ã–µ –∂–µ–ª–∞–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–µ —è–≤–ª—è—é—Ç—Å—è –∫–ª—é—á–æ–º –∫ –µ–≥–æ –∏—Å—Ç–∏–Ω–Ω–æ–π —Å–∏–ª–µ. –ß—Ç–æ –Ω—É–∂–Ω–æ –ø—Ä–æ—Ä–∞–±–æ—Ç–∞—Ç—å, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –∫–∞—Ä–º–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫ –≤ –ª—é–±–≤–∏?

        üíé 4. –†–ï–°–£–†–°–´ –ò –¢–ê–õ–ò–°–ú–ê–ù–´:
        –î–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Å–ø–∏—Å–æ–∫: –∫–∞–∫–æ–π –º–µ—Ç–∞–ª–ª, –∫–∞–º–µ–Ω—å (–º–∏–Ω–µ—Ä–∞–ª) –∏ —Ü–≤–µ—Ç —É—Å–∏–ª–∏–≤–∞—é—Ç —ç–Ω–µ—Ä–≥–µ—Ç–∏–∫—É ${name}. –í –∫–∞–∫–∏–µ –¥–Ω–∏ –Ω–µ–¥–µ–ª–∏ –µ–º—É –ª—É—á—à–µ –Ω–∞–∑–Ω–∞—á–∞—Ç—å –≤–∞–∂–Ω—ã–µ –≤—Å—Ç—Ä–µ—á–∏?

        üöÄ 5. –ü–†–û–ì–ù–û–°–¢–ò–ß–ï–°–ö–ò–ô –í–ï–ö–¢–û–† –ù–ê 2026 –ì–û–î:
        –ò—Å—Ö–æ–¥—è –∏–∑ —Ç–µ–∫—É—â–∏—Ö –ø–æ–ª–æ–∂–µ–Ω–∏–π, –≤—ã–¥–µ–ª–∏ 3 –≥–ª–∞–≤–Ω—ã—Ö —Ñ–æ–∫—É—Å–∞ –≤–Ω–∏–º–∞–Ω–∏—è –Ω–∞ –±–ª–∏–∂–∞–π—à–∏–µ 12 –º–µ—Å—è—Ü–µ–≤. –ß–µ–≥–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—á–µ—Å–∫–∏ –Ω–µ–ª—å–∑—è –¥–µ–ª–∞—Ç—å, —á—Ç–æ–±—ã –Ω–µ —Å–ª–∏—Ç—å —ç–Ω–µ—Ä–≥–∏—é?

        –°–¢–ò–õ–¨ –ü–ò–°–¨–ú–ê:
        - –≠–∫—Å–ø–µ—Ä—Ç–Ω—ã–π –∞–Ω–∞–ª–∏–∑, –Ω–∏–∫–∞–∫–æ–π –≤–æ–¥—ã. –û–±—Ä–∞—â–∞–π—Å—è –Ω–∞ "–í—ã".
        - –ò—Å–ø–æ–ª—å–∑—É–π —Ç–µ—Ä–º–∏–Ω—ã: "–∞—Å–ø–µ–∫—Ç", "—ç–Ω–µ—Ä–≥–∏—è", "—Ç—Ä–∞–Ω–∑–∏—Ç", "–∫–∞—Ä–º–∏—á–µ—Å–∫–∏–π —É–∑–µ–ª".
        - –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –æ–±—ä–µ–º ‚Äî 700-900 —Å–ª–æ–≤.

        –ü–ò–®–ò –ü–û–î–†–û–ë–ù–û, –ü–û–ö–ê –ù–ï –†–ê–ó–ë–ï–†–ï–®–¨ –í–°–ï 5 –ü–£–ù–ö–¢–û–í.
      `;
    } else {
      systemMessage = "–¢—ã ‚Äî –∫—Ä–∞—Ç–∫–∏–π –∏ –∏–Ω—Ç—Ä–∏–≥—É—é—â–∏–π –∞—Å—Ç—Ä–æ–ª–æ–≥.";
      userPrompt = `
        –°–¥–µ–ª–∞–π –∫—Ä–∞—Ç–∫–∏–π –¥–µ–º–æ-—Ä–∞–∑–±–æ—Ä –¥–ª—è ${name}.
        –§–ê–ö–¢–´: –°–æ–ª–Ω—Ü–µ –≤ ${sunSign}, –õ—É–Ω–∞ –≤ ${moonSign}.
        –ó–ê–î–ê–ß–ê: –ù–∞–ø–∏—à–∏ –û–î–ò–ù –∞–±–∑–∞—Ü –æ –≥–ª–∞–≤–Ω–æ–π –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–π —á–µ—Ä—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. 
        –í –∫–æ–Ω—Ü–µ –¥–æ–±–∞–≤—å –û–î–ù–û –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –æ —Ç–æ–º, —á—Ç–æ –µ–≥–æ –í–µ–Ω–µ—Ä–∞ –∏ –õ–∏–ª–∏—Ç —Å–∫—Ä—ã–≤–∞—é—Ç –≤–∞–∂–Ω—ã–µ –∫–ª—é—á–∏ –∫ –±–æ–≥–∞—Ç—Å—Ç–≤—É –∏ —Ç–µ–Ω–∏, –∫–æ—Ç–æ—Ä—ã–µ –¥–æ—Å—Ç—É–ø–Ω—ã –≤ –ø–æ–ª–Ω–æ–º VIP-—Ä–∞–∑–±–æ—Ä–µ.
        –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π —Å–∏–º–≤–æ–ª—ã **. –°—Ç–∏–ª—å: –ü—Ä–æ–≤–æ–∫–∞—Ü–∏–æ–Ω–Ω—ã–π –∏ –∏–Ω—Ç—Ä–∏–≥—É—é—â–∏–π.
      `;
    }

    const response = await fetch(
      "https://openrouter.ai/api/v1/chat/completions",
      {
        method: "POST",
        headers: {
          Authorization: `Bearer ${process.env.OPENROUTER_API_KEY}`,
          "Content-Type": "application/json",
          "HTTP-Referer": "http://localhost:3000",
          "X-Title": "Astro App",
        },
        body: JSON.stringify({
          model: "google/gemini-2.0-flash-001",
          messages: [
            { role: "system", content: systemMessage },
            { role: "user", content: userPrompt },
          ],
          temperature: 0.8,
          max_tokens: isPaid ? 4000 : 600,
        }),
      },
    );

    const data = await response.json();

    if (data.choices && data.choices[0]?.message?.content) {
      return NextResponse.json({ text: data.choices[0].message.content });
    }

    if (!response.ok) {
      console.error("–û–®–ò–ë–ö–ê OPENROUTER:", data);
      return NextResponse.json(
        { error: data.error?.message || "–û—à–∏–±–∫–∞ API" },
        { status: response.status },
      );
    }

    return NextResponse.json(
      { error: "–û—à–∏–±–∫–∞ API OpenRouter" },
      { status: 500 },
    );
  } catch (err: any) {
    return NextResponse.json({ error: err.message }, { status: 500 });
  }
}
